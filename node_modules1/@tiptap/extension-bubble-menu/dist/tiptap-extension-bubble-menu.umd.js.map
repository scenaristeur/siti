{"version":3,"file":"tiptap-extension-bubble-menu.umd.js","sources":["../src/bubble-menu-plugin.ts","../src/bubble-menu.ts"],"sourcesContent":["import { Editor, posToDOMRect, isNodeSelection } from '@tiptap/core'\nimport { EditorState, Plugin, PluginKey } from 'prosemirror-state'\nimport { EditorView } from 'prosemirror-view'\nimport tippy, { Instance, Props } from 'tippy.js'\n\nexport interface BubbleMenuPluginProps {\n  editor: Editor,\n  element: HTMLElement,\n  tippyOptions?: Partial<Props>,\n}\n\nexport type BubbleMenuViewProps = BubbleMenuPluginProps & {\n  view: EditorView,\n}\n\nexport class BubbleMenuView {\n  public editor: Editor\n\n  public element: HTMLElement\n\n  public view: EditorView\n\n  public preventHide = false\n\n  public tippy!: Instance\n\n  constructor({\n    editor,\n    element,\n    view,\n    tippyOptions,\n  }: BubbleMenuViewProps) {\n    this.editor = editor\n    this.element = element\n    this.view = view\n    this.element.addEventListener('mousedown', this.mousedownHandler, { capture: true })\n    this.editor.on('focus', this.focusHandler)\n    this.editor.on('blur', this.blurHandler)\n    this.createTooltip(tippyOptions)\n    this.element.style.visibility = 'visible'\n  }\n\n  mousedownHandler = () => {\n    this.preventHide = true\n  }\n\n  focusHandler = () => {\n    // we use `setTimeout` to make sure `selection` is already updated\n    setTimeout(() => this.update(this.editor.view))\n  }\n\n  blurHandler = ({ event }: { event: FocusEvent }) => {\n    if (this.preventHide) {\n      this.preventHide = false\n\n      return\n    }\n\n    if (\n      event?.relatedTarget\n      && this.element.parentNode?.contains(event.relatedTarget as Node)\n    ) {\n      return\n    }\n\n    this.hide()\n  }\n\n  createTooltip(options: Partial<Props> = {}) {\n    this.tippy = tippy(this.view.dom, {\n      duration: 0,\n      getReferenceClientRect: null,\n      content: this.element,\n      interactive: true,\n      trigger: 'manual',\n      placement: 'top',\n      hideOnClick: 'toggle',\n      ...options,\n    })\n  }\n\n  update(view: EditorView, oldState?: EditorState) {\n    const { state, composing } = view\n    const { doc, selection } = state\n    const isSame = oldState && oldState.doc.eq(doc) && oldState.selection.eq(selection)\n\n    if (composing || isSame) {\n      return\n    }\n\n    const { empty, $anchor, ranges } = selection\n\n    // support for CellSelections\n    const from = Math.min(...ranges.map(range => range.$from.pos))\n    const to = Math.max(...ranges.map(range => range.$to.pos))\n\n    // Sometime check for `empty` is not enough.\n    // Doubleclick an empty paragraph returns a node size of 2.\n    // So we check also for an empty text size.\n    if (empty || !$anchor.parent.textContent) {\n      this.hide()\n\n      return\n    }\n\n    this.tippy.setProps({\n      getReferenceClientRect: () => {\n        if (isNodeSelection(view.state.selection)) {\n          const node = view.nodeDOM(from) as HTMLElement\n\n          if (node) {\n            return node.getBoundingClientRect()\n          }\n        }\n\n        return posToDOMRect(view, from, to)\n      },\n    })\n\n    this.show()\n  }\n\n  show() {\n    this.tippy.show()\n  }\n\n  hide() {\n    this.tippy.hide()\n  }\n\n  destroy() {\n    this.tippy.destroy()\n    this.element.removeEventListener('mousedown', this.mousedownHandler)\n    this.editor.off('focus', this.focusHandler)\n    this.editor.off('blur', this.blurHandler)\n  }\n}\n\nexport const BubbleMenuPluginKey = new PluginKey('menuBubble')\n\nexport const BubbleMenuPlugin = (options: BubbleMenuPluginProps) => {\n  return new Plugin({\n    key: BubbleMenuPluginKey,\n    view: view => new BubbleMenuView({ view, ...options }),\n  })\n}\n","import { Extension } from '@tiptap/core'\nimport { BubbleMenuPlugin, BubbleMenuPluginProps } from './bubble-menu-plugin'\n\nexport type BubbleMenuOptions = Omit<BubbleMenuPluginProps, 'editor' | 'element'> & {\n  element: HTMLElement | null,\n}\n\nexport const BubbleMenu = Extension.create<BubbleMenuOptions>({\n  name: 'bubbleMenu',\n\n  defaultOptions: {\n    element: null,\n    tippyOptions: {},\n  },\n\n  addProseMirrorPlugins() {\n    if (!this.options.element) {\n      return []\n    }\n\n    return [\n      BubbleMenuPlugin({\n        editor: this.editor,\n        element: this.options.element,\n        tippyOptions: this.options.tippyOptions,\n      }),\n    ]\n  },\n})\n"],"names":["tippy","isNodeSelection","posToDOMRect","PluginKey","Plugin","Extension"],"mappings":"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"}